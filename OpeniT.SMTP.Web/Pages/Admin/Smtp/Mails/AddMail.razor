@namespace OpeniT.SMTP.Web.Pages.Admin

@if (isBusy)
{
	<div class="@(IsOpen ? "overlay align-items-start" : "d-none")" style="top: 0; left: 0; ">
		<MatProgressBar Style="position: fixed; top: calc(3.5rem + 1px);" Indeterminate="true"></MatProgressBar>
	</div>
}
<div class="@(IsOpen ? "animateFadeIn" : "d-none")" style="min-height: inherit; background-color: #eee;">
	<section class="content-header position-sticky">
		<div class="container-fluid d-flex align-items-center justify-content-between pt-2 pb-2 pl-responsive pr-responsive">
			<div class="d-flex align-items-center">
				<div class="d-flex align-items-center border-right pr-3">
					<MatIcon Icon="library_add"></MatIcon>
					<span class="text-lg text-bold ml-1">New Mail</span>
				</div>
				<div class="pl-3">
					<span class="text-bold text-gray mb-0">Enter mail details and send</span>
				</div>
			</div>
			<div class="text-right">
				<MatButton Disabled="isBusy" Unelevated="true" OnClick="this.Close" Icon="chevron_left" Label="Back" Class="mdc-button-primary font-weight-normal"></MatButton>
				<MatButton Disabled="isBusy" Unelevated="true" OnClick="this.Save">
					<i class="mdc-button__icon fas m-0 @(isBusy ? "fa-circle-notch fa-spin" : "fa-save")"></i> <span class="ml-2">Send</span>
				</MatButton>
			</div>
		</div>
	</section>
	<section class="content p-responsive">
		<div class="container-fluid p-0">
			<div class="card card-default box-shadow-none mb-0">
				<div class="card-header pl-responsive pr-responsive">
					<h3 class="card-title">Mail Details</h3>
				</div>
				<div class="card-body p-responsive">
					<FormValidator @ref="@formValidator" EditContext="@editContext" class="m-0">
						@if (context?.Model?.GetType() == typeof(SmtpMail))
						{
							var model = editContext.Model as SmtpMail;
							<div class="form-group d-flex align-items-center">
								<div class="flex-basis-50 position-relative pr-2">
									<MatTextField @ref="@MailFromTextField" @bind-Value="@mailFrom" OnInput="e => this.MailFromAddressChanged(e.Value.ToString())" @onclick="async () => await this.UpdateMailAddressesMenuAnchor(MailFromTextField.Ref)" OnFocus="async () => await this.UpdateMailAddressesMenuAnchor(MailFromTextField.Ref)" Disabled="isBusy" Label="From Address * " Class="hide-validation-line full-width m-0"></MatTextField>
									<FieldValidator TValue="string" For="@(() => model.From.Address)" AdditionalValidators="@fromAddressValidators" Class="@(this.IsMailAddressMenuOpen(MailFromTextField?.Ref) ? "d-none" : string.Empty)" Style="min-width: unset;"></FieldValidator>
								</div>
								<div class="flex-basis-50 position-relative pl-2">
									<MatTextField @bind-Value="model.From.DisplayName" Disabled="isBusy" Label="From Display Name" Class="hide-validation-line full-width m-0"></MatTextField>
								</div>
							</div>
							<div class="form-group position-relative">
								<MatTextField @ref="@MailToTextField" @bind-Value="@mailTo" OnInput="e => this.MailToChanged(e.Value.ToString())" @onclick="async () => await this.UpdateMailAddressesMenuAnchor(MailToTextField.Ref)" OnFocus="async () => await this.UpdateMailAddressesMenuAnchor(MailToTextField.Ref)" Disabled="isBusy" Label="To *" Class="hide-validation-line full-width m-0"></MatTextField>
								<FieldValidator TValue="ICollection<SmtpMailAddress>" For="@(() => model.To)" AdditionalValidators="@toValidators" Class="@(this.IsMailAddressMenuOpen(MailToTextField?.Ref) ? "d-none" : string.Empty)" Style="min-width: unset;"></FieldValidator>
							</div>
							<div class="form-group position-relative">
								<MatTextField @ref="@MailCCTextField" @bind-Value="@mailCC" OnInput="e => this.MailCcChanged(e.Value.ToString())" @onclick="async () => await this.UpdateMailAddressesMenuAnchor(MailCCTextField.Ref)" OnFocus="async () => await this.UpdateMailAddressesMenuAnchor(MailCCTextField.Ref)" Disabled="isBusy" Label="CC" Class="hide-validation-line full-width m-0"></MatTextField>
								<FieldValidator TValue="ICollection<SmtpMailAddress>" For="@(() => model.CC)" AdditionalValidators="@ccValidators" Class="@(this.IsMailAddressMenuOpen(MailCCTextField?.Ref) ? "d-none" : string.Empty)" Style="min-width: unset;"></FieldValidator>
							</div>
							<div class="form-group position-relative">
								<MatTextField @ref="@MailBCCTextField" @bind-Value="@mailBCC" OnInput="e => this.MailBccChanged(e.Value.ToString())" @onclick="async () => await this.UpdateMailAddressesMenuAnchor(MailBCCTextField.Ref)" OnFocus="async () => await this.UpdateMailAddressesMenuAnchor(MailBCCTextField.Ref)" Disabled="isBusy" Label="BCC" Class="hide-validation-line full-width m-0"></MatTextField>
								<FieldValidator TValue="ICollection<SmtpMailAddress>" For="@(() => model.BCC)" AdditionalValidators="@bccValidators" Class="@(this.IsMailAddressMenuOpen(MailBCCTextField?.Ref) ? "d-none" : string.Empty)" Style="min-width: unset;"></FieldValidator>
							</div>
							<div class="form-group position-relative">
								<MatTextField @bind-Value="@model.Subject" Disabled="isBusy" Label="Subject *" Class="hide-validation-line full-width m-0"></MatTextField>
								<FieldValidator TValue="string" For="@(() => model.Subject)" AdditionalValidators="@subjectValidators" Style="min-width: unset;"></FieldValidator>
							</div>
							<div class="form-group position-relative">
								<label class="w-100 m-0">Body Format *</label>
								<MatRadioGroup Value="@model.IsBodyHtml" ValueChanged="(bool value) => { model.Body = null; model.IsBodyHtml = value; }" ValueExpression="() => model.IsBodyHtml">
									<MatRadioButton Value="false" Label="Plain Text" Class="pr-1 pl-0"></MatRadioButton>
									<MatRadioButton Value="true" Label="Html" Class="pr-1"></MatRadioButton>
								</MatRadioGroup>
							</div>
							<div class="form-group position-relative">
								@if (model.IsBodyHtml)
								{
									<label class="m-0">Place Body *</label>
									<GrapesjsEditor @ref="grapesjsEditor" Value="@model.Body" Disabled="isBusy">
										<IsBusyContent>
											<div class="overlay" style="z-index: 2;">
												<MatProgressBar Indeterminate="true" Style="position: absolute; top: 0;"></MatProgressBar>
											</div>
										</IsBusyContent>
									</GrapesjsEditor>
								}
								else
								{
									<MatTextField @bind-Value="@model.Body" Disabled="isBusy" Label="Place Body * " TextArea="true" Class="hide-validation-line full-width h-100 m-0" Style="min-height: 10rem"></MatTextField>
								}
								<FieldValidator TValue="string" For="@(() => model.Body)" AdditionalValidators="@bodyValidators" Style="min-width: unset;"></FieldValidator>
							</div>
						}
					</FormValidator>
				</div>
				<Menu @ref="@MailAddressesMenu" IsOpenChanged="StateHasChanged">
					<MatList>
						@{
							var mailAddresses = MailAddresses?.Where(a => a?.ToLower()?.Contains(mailAddressesSearchText?.ToLower() ?? string.Empty) == true) ?? Enumerable.Empty<string>();
							if (mailAddresses.Any())
							{
								@foreach (var mailAddress in mailAddresses)
								{
									<MatListItem OnClick="() => this.MailAddressClicked(mailAddress)">
										@((MarkupString)mailAddress.Highlight(mailAddressesSearchText))
									</MatListItem>
								}
							}
							else
							{
								<MatListItem Class="bg-white box-shadow-none text-dark cursor-default">Your search: @mailAddressesSearchText did not match any selection.</MatListItem>
							}
						}
					</MatList>
				</Menu>
			</div>
		</div>
	</section>
</div>